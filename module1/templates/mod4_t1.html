{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Project Ideation Journey</title>
    <style>
        body {
            font-family: 'Inter', sans-serif; 
            margin: 0;
            /* overflow: hidden;  Initially hide overflow for loading, JS will manage it */
            display: flex; 
            min-height: 100vh; 
        }
        .scrollable-dropdown::-webkit-scrollbar,
        #activity-log::-webkit-scrollbar { 
            width: 8px;
        }
        .scrollable-dropdown::-webkit-scrollbar-track,
        #activity-log::-webkit-scrollbar-track {
            background: #4a5568; 
            border-radius: 10px;
        }
        .scrollable-dropdown::-webkit-scrollbar-thumb,
        #activity-log::-webkit-scrollbar-thumb {
            background: #718096; 
            border-radius: 10px;
        }
        .scrollable-dropdown::-webkit-scrollbar-thumb:hover,
        #activity-log::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; 
        }
        .scrollable-dropdown {
            max-height: 200px; 
            overflow-y: auto;
        }
        main {
            overflow-y: auto;
        }
        aside#leftSidebar { 
            display: flex;
            flex-direction: column;
        }
        .finance-modal-text {
            font-family: 'Courier New', Courier, monospace; 
        }
        #modalBackdrop .modal-content-area {
            font-family: 'Arial', sans-serif; 
        }
        #modalBackdrop .modal-title {
            background-color: #4A5568; 
            color: white;
            padding: 0.75rem 1.25rem; 
            border-top-left-radius: 0.5rem; 
            border-top-right-radius: 0.5rem;
            font-weight: bold;
            font-size: 1.125rem; 
            text-align: center;
        }
         #modalBackdrop .modal-description {
            padding: 1.5rem; 
            text-align: center;
            font-size: 1rem; 
            color: #E2E8F0; 
        }
        #modalBackdrop .modal-cost {
            text-align: center;
            font-size: 1.5rem; 
            font-weight: bold;
            color: #EC4899; 
            margin-bottom: 0.75rem; 
        }
        #modalBackdrop .modal-success-chance {
            text-align: center;
            font-size: 0.875rem; 
            color: #A0AEC0; 
            margin-bottom: 1.5rem; 
        }
        #modalBackdrop .modal-select-button {
            background-color: #63B3ED; 
            color: white;
            font-weight: bold;
            padding: 0.75rem 2rem; 
            border-radius: 0.5rem; 
            transition: background-color 0.2s;
            border: 2px solid #90CDF4; 
        }
        #modalBackdrop .modal-select-button:hover {
            background-color: #4299E1; 
        }
        #modalBackdrop .modal-close-button {
            position: absolute;
            top: 0.75rem; 
            right: 0.75rem; 
            color: #CBD5E0; 
        }
         #modalBackdrop .modal-close-button:hover {
            color: white;
        }
        .dropdown-item-disabled {
            color: #718096 !important; 
            cursor: not-allowed !important;
            background-color: #2D3748 !important; 
        }
        .dropdown-item-disabled:hover {
            background-color: #2D3748 !important; 
        }
        .dropdown-item-active {
            /* Standard hover:bg-purple-400 is fine */
        }
         .dropdown-item-completed {
            color: #a0aec0; 
            background-color: #4A5568; 
            cursor: default;
        }
        .dropdown-item-completed:hover {
            background-color: #4A5568 !important;
        }

        /* Action Outcome Modal Styles */
        #actionOutcomeModal .modal-title-success { background-color: #38A169; /* Tailwind green-600 */ }
        #actionOutcomeModal .modal-title-failure { background-color: #E53E3E; /* Tailwind red-600 */ }
        #actionOutcomeModal .modal-title-neutral { background-color: #4A5568; /* Tailwind gray-700 */ }

        /* Loading Screen Styles */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('{% static 'mod4bg.gif' %}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #1a202c; /* Tailwind gray-900 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999; /* Ensure it's on top */
            color: white;
            transition: opacity 0.5s ease-out;
        }
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Allow clicks through when hidden */
        }
        .loading-title {
            font-size: 3rem; /* Tailwind text-5xl */
            font-weight: bold;
            margin-bottom: 0.5rem; /* Tailwind mb-2 */
            letter-spacing: 0.05em; /* Tailwind tracking-wider */
            color: #a0aec0; /* Tailwind gray-400 */
        }
        .loading-subtitle {
            font-size: 1.25rem; /* Tailwind text-xl */
            margin-bottom: 2rem; /* Tailwind mb-8 */
            color: #718096; /* Tailwind gray-500 */
        }
        .loader {
            border: 8px solid #4a5568; /* Tailwind gray-700 */
            border-top: 8px solid #63b3ed; /* Tailwind blue-400 */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide main content initially */
        .content-wrapper {
            display: none; /* Initially hidden, JS will show it */
            width: 100%; /* Ensure it takes full width after loading */
            flex-grow: 1; /* Allow it to grow and fill space */
        }

    </style>
    <script>
        // --- Game State Variables ---
        let companyHealthPercentage = 50; 
        let marketDominationPercentage = 50; 
        let customerSatisfactionPercentage = 50; 
        let balancedBooksPercentage = 50;  
        let employees = 0;          
        let balance = 15000; 
        let businessName = "Stellar Innovations"; 
        let businessType = "Web Development Services";  
        let businessLocation = "Home-Based"; 
        let icon = "üíª"; 

        let currentYear = 1;
        let currentQuarter = 1;
        let actionPoints = 4;
        let insuranceBonus = 0; 

        const businessTypeToCategoryMapping = {
            "IoT Device Development": "1",
            "Web Development Services": "1",
            "Activewear Line": "1",
            "Tech Repair and Support": "2",
            "Specialty Coffee Shop": "2",
            "Artisan Bakery": "2",
            "Food Truck Business": "2",
            "Custom Tailored Clothing": "2",
            "Online T-Shirt Printing": "2",
            "Spa and Massage Center": "2",
            "Home Cleaning Service": "2",
            "Interior Design and Home Staging": "2"
        };

        const businessTypeIcons = {
            "IoT Device Development": "ü§ñ",
            "Web Development Services": "üíª",
            "Activewear Line": "üèÉ‚Äç‚ôÄÔ∏è",
            "Tech Repair and Support": "üõ†Ô∏è",
            "Specialty Coffee Shop": "‚òï",
            "Artisan Bakery": "ü•ê",
            "Food Truck Business": "üöö",
            "Custom Tailored Clothing": "üßµ",
            "Online T-Shirt Printing": "üëï", 
            "Spa and Massage Center": "üíÜ",
            "Home Cleaning Service": "üßπ",
            "Interior Design and Home Staging": "üõãÔ∏è",
            "Generic": "üè¢" 
        };

        const category1StageOrder = [ 
            "Research: Interview potential customers",
            "Design: Design your product",
            "Sourcing: Source potential manufacturers/suppliers",
            "Quality Control: Test prototypes/samples",
            "Launch: Launch your product"
        ];
        let currentSoftwareDevelopmentStageIndex = 0; 
        let productV1Launched = false; 

        const category2StageOrder = [
            "Order Products",
            "Perform Maintenance",
            "Make a Sale",
            "Offer Discount"
        ];
        let currentCategory2StageIndex = 0; 


        let quarterlySales = 0;
        let quarterlyIncomeFromActionsAndEvents = 0;
        let quarterlyExpensesFromActionsAndEvents = 0;
        let quarterlyServiceCosts = 0;
        
        const RENT_HOME_BASED = 0;
        const RENT_PHYSICAL_STORE = 1000;
        const RENT_COMMERCIAL_SPACE = 2500;

        const SALARY_PER_EMPLOYEE_PER_QUARTER = 5000; 
        const SALES_PER_EMPLOYEE_PER_QUARTER = 7000; 
        const LOAN_REPAYMENT_PER_QUARTER = 900;

        // NEW: Max employee constants
        const MAX_EMPLOYEES_HOME_BASED = 3;
        const MAX_EMPLOYEES_PHYSICAL_STORE = 7;
        const MAX_EMPLOYEES_COMMERCIAL_SPACE = 15;
        
        // --- Action Definitions ---
        if (typeof window.businessTypeActions === 'undefined') {
            window.businessTypeActions = {
                "1": { 
                    "Research: Interview potential customers": { 
                        label: "Research Customers", 
                        actionKey: "Research: Interview potential customers", 
                        title: "Step 1: Research", 
                        description: "Interview potential customers to identify desirable product features.", 
                        financialCost: 100, apCost: 1, successChance: 70, 
                        isSequential: true,
                        effects: {
                            success: { message: "Research successful: Gathered valuable customer insights!", csChange: 5 },
                            failure: { message: "Research failed: No useful information gathered." }
                        }
                    },
                    "Design: Design your product": { 
                        label: "Design Product", 
                        actionKey: "Design: Design your product", 
                        title: "Step 2: Design", 
                        description: "It‚Äôs time to use what you learned during the research phase. Design your product.", 
                        financialCost: 500, apCost: 1, successChance: 70, 
                        isSequential: true,
                        effects: {
                            success: { message: "Design successful: Product design looks great!", mdChange: 5 },
                            failure: { message: "Design failed: Design has flaws, back to the drawing board.", csChange: -5 }
                        }
                    },
                    "Sourcing: Source potential manufacturers/suppliers": { 
                        label: "Source Suppliers/Mfg.", 
                        actionKey: "Sourcing: Source potential manufacturers/suppliers", 
                        title: "Step 3: Sourcing", 
                        description: "Find and vet potential manufacturers or suppliers for your product components or materials.", 
                        financialCost: 2000, apCost: 1, successChance: 80, 
                        isSequential: true,
                        effects: {
                            success: { message: "Sourcing successful: Contracts signed!", healthChange: 5 }, 
                            failure: { message: "Sourcing failed: No suitable suppliers/manufacturers found."}
                        } 
                    },
                    "Quality Control: Test prototypes/samples": { 
                        label: "Test Prototypes/Samples", 
                        actionKey: "Quality Control: Test prototypes/samples", 
                        title: "Step 4: Quality Control", 
                        description: "Test prototypes or initial production samples to ensure they meet your quality standards and specifications.", 
                        financialCost: 500, apCost: 1, successChance: 70,
                        isSequential: true,
                        effects: {
                            success: { message: "Quality Control successful: Samples meet specs!", healthChange: 10, csChange: 5 },
                            failure: { message: "Quality Control failed: Samples have issues!", healthChange: -10, csChange: -10 }
                        }
                    },
                    "Launch: Launch your product": { 
                        label: "Launch Product", 
                        actionKey: "Launch: Launch your product", 
                        title: "Step 5: Launch", 
                        description: "All your hard work has paid off! Launch your product.", 
                        financialCost: 2000, apCost: 1, successChance: 80, 
                        isSequential: true,
                        effects: {
                            success: { message: "Product Launch successful! Customers love it! +$15,000 initial sales!", mdChange: 25, csChange: 20, balanceGain: 15000 },
                            failure: { message: "Product Launch failed! Major issues reported.", mdChange: -10, csChange: -25, healthChange: -15 }
                        }
                    },
                    "Announce new product/version": { 
                        label: "Announce Product vNext", 
                        actionKey: "Announce new product/version", 
                        title: "Product Update: Announce Next Version", 
                        description: "Generate buzz for the next iteration or a new product line based on your initial success.", 
                        financialCost: 100, apCost: 1, successChance: null, 
                        requiresV1Launch: true, 
                        effects: { 
                            success: { message: "New product/version announced. Public is excited!", csChange: 8, mdChange: 3 },
                            failure: { message: "New product/version announcement met with skepticism.", csChange: -4 }
                        }
                    },
                    "Post on social media (Product Dev Focus)": { 
                        label: "Post Dev/Design Update", 
                        actionKey: "Post on social media (Product Dev Focus)", 
                        title: "Dev/Design Update: Social Media", 
                        description: "Update your followers on your product development or design progress.", 
                        financialCost: 100, apCost: 1, successChance: 60,
                        isAlwaysAvailable: true, 
                        effects: {
                            success: { message: "Dev/Design Update (Social Media): Positive engagement!", csChange: 4, mdChange: 3 },
                            failure: { message: "Dev/Design Update (Social Media): Low interest.", csChange: -2 }
                        }
                    }
                },
                "2": { 
                    "Order Products": {
                        label: "Order Products",
                        actionKey: "Order Products",
                        title: "Step 1: Order Products", 
                        description: "Restock? Supplies are looking a little low‚Ä¶ This will boost sales long into next quarter!",
                        financialCost: 800,
                        apCost: 1, 
                        successChance: null, 
                        isSequential: true, 
                        effects: {
                            success: { message: "Success! New supplies are added. This should help future sales. MD +2.", mdChange: 2 }
                        }
                    },
                    "Perform Maintenance": {
                        label: "Perform Maintenance",
                        actionKey: "Perform Maintenance",
                        title: "Step 2: Maintenance", 
                        description: "Hire a cleaning service and spruce things up a bit?",
                        financialCost: 100,
                        apCost: 1,
                        successChance: null, 
                        isSequential: true, 
                        effects: {
                            success: { message: "Maintenance complete. Yeah, good idea, the floors were getting a bit sticky! Place looks fresh. CS +2.", csChange: 2 }
                        }
                    },
                    "Make a Sale": {
                        label: "Make a Sale",
                        actionKey: "Make a Sale",
                        title: "Step 3: Make a Sale", 
                        description: "Gather point-of-sale revenue.",
                        financialCost: 0,
                        apCost: 1,
                        successChance: 80,
                        isSequential: true, 
                        effects: {
                            success: { message: "Congrats on the new revenue! +$500", balanceGain: 500 },
                            failure: { message: "The sale attempt was unsuccessful this time." }
                        }
                    },
                    "Offer Discount": {
                        label: "Offer Discount",
                        actionKey: "Offer Discount",
                        title: "Step 4: Offer Discount", 
                        description: "Put a coupon in the local paper to drive traffic.",
                        financialCost: 500,
                        apCost: 1,
                        successChance: 50,
                        isSequential: true, 
                        effects: {
                            success: { message: "The line is out the door! People love a good discount. Who knew! MD +5, CS +3.", mdChange: 5, csChange: 3 },
                            failure: { message: "Your coupon had the wrong address. You should be more careful next time. CS -2.", csChange: -2 }
                        }
                    },
                    "Redesign Store": { 
                        label: "Redesign Store",
                        actionKey: "Redesign Store",
                        title: "Operations: Redesign Store",
                        description: "Update the store‚Äôs vibe. This will attract more customers.",
                        financialCost: 2000,
                        apCost: 2, 
                        successChance: null, 
                        isAlwaysAvailable: true, 
                        effects: {
                            success: { message: "Redesign complete! Your friends told you this paint color was too much. They were so wrong! The place looks great. MD +7, CS +4.", mdChange: 7, csChange: 4 }
                        }
                    },
                    "Customer Follow-up": { 
                        label: "Customer Follow-up",
                        actionKey: "Customer Follow-up",
                        title: "Customer Service: Follow-up",
                        description: "Call past clients to check to ensure satisfaction with your work. It‚Äôs always nice to go the extra mile.",
                        financialCost: 50,
                        apCost: 1,
                        successChance: 60,
                        isAlwaysAvailable: true, 
                        effects: {
                            success: { message: "You don‚Äôt exist without your customers. Smart going to reach out to them and find out what else they need. CS +5.", csChange: 5 },
                            failure: { message: "Couldn't reach many clients, or the feedback was neutral. No significant change." }
                        }
                    },
                    "Post Design/Service Update (Cat2)": { 
                        label: "Post Design/Service Update",
                        actionKey: "Post Design/Service Update (Cat2)",
                        title: "Social Media: Design/Service Update",
                        description: "Share the current status of your store design, product displays, or service offerings.",
                        financialCost: 100,
                        apCost: 1,
                        successChance: 50,
                        isAlwaysAvailable: true, 
                        effects: {
                            success: { message: "You took a few pictures and posted them. People seem to be very engaged! MD +3, CS +2.", mdChange: 3, csChange: 2 },
                            failure: { message: "Your social media post didn't get much engagement this time." }
                        }
                    }
                }
            };
        }
        if (typeof window.commonActions === 'undefined') {
            window.commonActions = {
                "Local Outreach": { 
                    label: "Local Outreach", 
                    actionKey: "Local Outreach", 
                    title: "Local Outreach", 
                    description: "Print out 200 \"Now Hiring\" posters and hang them around town. Hopefully someone will see them!", 
                    financialCost: 50, apCost: 1, successChance: 35, 
                    effects: { 
                        success: { message: "Posters attracted some attention! Hired 1 new employee.", employeeGain: 1 },
                        failure: { message: "The posters didn't attract any suitable candidates." }
                    }
                }, 
                "Online Websites": { 
                    label: "Online Websites", 
                    actionKey: "Online Websites", 
                    title: "Hiring Website", 
                    description: "Post a job description on the popular website JobSloth.net.", 
                    financialCost: 200, apCost: 1, successChance: 50, 
                    effects: { 
                        success: { message: "JobSloth.net ad was a success! Hired 1 new employee.", employeeGain: 1 },
                        failure: { message: "The JobSloth.net ad yielded no suitable candidates."}
                    }
                }, 
                "Recruiter": { 
                    label: "Recruiter", 
                    actionKey: "Recruiter", 
                    title: "Hire a Recruiter", 
                    description: "Hire a recruiter. They have a good feeling about finding the right person.", 
                    financialCost: 500, apCost: 1, successChance: 90, 
                    effects: { 
                        success: { message: "The recruiter found great talent! Hired 1 new employee.", employeeGain: 1 },
                        failure: { message: "The recruiter couldn't find anyone suitable this time."}
                    }
                }, 
                "Fire a Person": { label: "Fire a Person", actionKey: "Fire a Person", title: "HR: Fire Employee", description: "Terminate an employee's contract.", financialCost: 1000, apCost: 1, successChance: null, effects: { success: { message: "Fired an employee. Severance: -$1000. CS -5.", employeeGain: -1, csChange: -5 }}},
                "Hire a Lawyer": { label: "Hire a Lawyer", actionKey: "Hire a Lawyer", title: "Services: Hire Lawyer", description: "Engage legal services for your company.", financialCost: 3000, apCost: 1, successChance: null, effects: { success: { message: "Hired a Lawyer. Legal Papers +20.", lpChange: 20 }}}, 
                "Purchase Business Insurance": { 
                    label: "Purchase Business Insurance", 
                    actionKey: "Purchase Business Insurance", 
                    title: "Services: Get Insurance", 
                    description: "Secure insurance coverage for your business. This provides a permanent boost to your company's resilience.", 
                    financialCost: 4000, apCost: 1, successChance: null, 
                    effects: { 
                        success: { 
                            message: "Purchased Business Insurance! Company resilience permanently improved.", 
                            applyInsuranceBonus: true 
                        }
                    }
                }, 
                "Marketing Campaign": { label: "Marketing Campaign", actionKey: "Marketing Campaign", title: "Services: Marketing Campaign", description: "Launch a new marketing campaign to boost visibility.", financialCost: 6000, apCost: 1, successChance: null, effects: { success: { message: "Launched Marketing Campaign. MD +15, CS +5.", mdChange: 15, csChange: 5 }}} 
            };
        }
        
        // Merge common actions into each CATEGORY's actions
        if (window.businessTypeActions && window.commonActions) {
            for (const categoryKey in window.businessTypeActions) { 
                if (Object.hasOwnProperty.call(window.businessTypeActions, categoryKey)) {
                    window.businessTypeActions[categoryKey] = {
                        ...window.businessTypeActions[categoryKey],
                        ...window.commonActions 
                    };
                }
            }
        }
    </script>
</head>
<body class="bg-gray-800 text-white">
    <div id="loading-screen">
        <div class="loading-title">FinSta</div>
        <div class="loading-subtitle">Financial Startup Simulator</div>
        <div class="loader"></div>
    </div>

    <div class="content-wrapper flex">
        <aside id="leftSidebar" class="bg-slate-900 w-full md:w-1/4 flex flex-col p-4 md:p-6 space-y-4 md:space-y-6 h-screen overflow-y-auto">
            <div id="businessInfoSection">
                <div class="flex items-center mb-4">
                    <div id="businessIconDisplay" class="w-12 h-12 md:w-16 md:h-16 bg-amber-400 text-amber-900 flex items-center justify-center rounded-lg text-2xl md:text-3xl font-bold shadow-md"></div>
                    <div class="ml-3 md:ml-4">
                        <div id="businessNameDisplay" class="text-lg md:text-xl font-semibold"></div>
                        <div id="businessTypeDisplay" class="text-xs md:text-sm text-gray-400"></div>
                        </div>
                </div>
            </div>
            <div class="bg-slate-800 p-3 md:p-4 rounded-lg shadow">
                <div id="yearQuarterDisplay" class="text-xs md:text-sm text-gray-400 mb-1 md:mb-2">Year 1, Q1</div>
                <div class="flex flex-col sm:flex-row sm:justify-between space-y-1 sm:space-y-0 sm:space-x-2 text-xs md:text-sm">
                    <div>Employees: <span class="font-semibold text-sky-400" id="employeeCount"></span></div>
                    <div>Balance: <span class="font-semibold text-emerald-400" id="accountBalance"></span></div>
                </div>
            </div>
            <div class="bg-slate-800 p-3 md:p-4 rounded-lg shadow">
                <div class="text-sm md:text-base font-semibold text-white mb-2 md:mb-3">Company Stats</div>
                <div class="space-y-3 md:space-y-4"> 
                    <div class="text-xs md:text-sm">
                        <span class="text-gray-300 block mb-1">Company Health</span>
                        <div class="bg-gray-700 rounded-full h-2.5 md:h-3 w-full overflow-hidden">
                            <div id="companyHealthBar" class="bg-sky-500 h-full rounded-full transition-all duration-500 ease-out"></div>
                        </div>
                    </div>
                    <div class="text-xs md:text-sm">
                        <span class="text-gray-300 block mb-1">Market Domination</span>
                        <div class="bg-gray-700 rounded-full h-2.5 md:h-3 w-full overflow-hidden">
                            <div id="marketDominationBar" class="bg-indigo-500 h-full rounded-full transition-all duration-500 ease-out" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="text-xs md:text-sm">
                        <span class="text-gray-300 block mb-1">Customer Satisfaction</span>
                        <div class="bg-gray-700 rounded-full h-2.5 md:h-3 w-full overflow-hidden">
                            <div id="customerSatisfactionBar" class="bg-emerald-500 h-full rounded-full transition-all duration-500 ease-out" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="text-xs md:text-sm">
                        <span class="text-gray-300 block mb-1">Legal Papers</span>
                        <div class="bg-gray-700 rounded-full h-2.5 md:h-3 w-full overflow-hidden">
                            <div id="balancedBooksBar" class="bg-yellow-500 h-full rounded-full transition-all duration-500 ease-out" style="width: 50%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-grow p-4 md:p-8 bg-cover bg-center bg-no-repeat" style="background-image: url('{% static 'mod4bg.gif' %}')">
            <h1 id="mainContentHeader" class="text-xl sm:text-2xl md:text-3xl font-semibold mb-3 md:mb-4 text-shadow">Welcome to the Project Ideation Journey</h1>
            <p id="mainContentSubtext" class="text-gray-300 text-sm md:text-base text-shadow-sm">Start your business simulation by selecting an option from the sidebar. Good luck!</p>
        </main>

        <aside class="bg-amber-600/80 backdrop-blur-sm fixed bottom-4 right-4 p-3 md:p-4 h-auto max-h-[33vh] w-full sm:w-1/3 md:w-1/4 lg:w-1/5 z-20 rounded-lg shadow-xl flex flex-col overflow-hidden" id="activityLogContainer">
            <div class="text-base md:text-lg font-semibold mb-2 text-white bg-amber-700 p-2 rounded-md">Activity Log</div> 
            <div id="activity-log" class="space-y-2 flex-grow overflow-y-auto"></div>
        </aside>

        <button onclick="window.toggleSettingsModal()" title="Game Settings" class="fixed bottom-4 left-4 bg-slate-700 hover:bg-slate-600 text-white p-3 rounded-full shadow-lg z-30 transition-colors duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 1.905c-.007.379.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.759 6.759 0 010-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>

        <div class="fixed top-6 right-6 z-30">
            <div class="relative">
                <button onclick="window.toggleActions()" class="bg-purple-700 hover:bg-purple-600 text-white py-2.5 md:py-3 px-3 md:px-4 rounded-lg w-auto flex items-center justify-between shadow-lg transition-colors duration-150">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 md:w-6 md:h-6 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        <span class="text-sm md:text-base">Actions</span>
                    </div>
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 md:w-5 md:h-5 mr-1 md:mr-2 transform transition-transform duration-300" id="actionsChevron">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                        <span id="actionPointsDisplay" class="font-semibold bg-purple-900 px-2 py-0.5 rounded-md text-xs md:text-sm"></span>
                    </div>
                </button>
                <div id="actionsDropdown" class="hidden absolute top-full right-0 mt-1 bg-purple-600 text-white rounded-lg shadow-xl w-72 z-20 overflow-hidden">
                    <div id="dropdown-1" class="relative border-b border-purple-500">
                        <button onclick="window.openDropDown(1)" class="py-2 md:py-2.5 px-3 md:px-4 w-full flex items-center justify-between hover:bg-purple-500 transition-colors duration-150 text-sm md:text-base">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 md:w-5 md:h-5 mr-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0l2-2m-2 2l-2-2" />
                                </svg>
                                Operations
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-2 transform transition-transform duration-300" data-chevron-id="1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                        <div id="dropdownMenu1" class="hidden bg-purple-500 text-white scrollable-dropdown"></div>
                    </div>
                    <div id="dropdown-2" class="relative border-b border-purple-500">
                        <button onclick="window.openDropDown(2)" class="py-2 md:py-2.5 px-3 md:px-4 w-full flex items-center justify-between hover:bg-purple-500 transition-colors duration-150 text-sm md:text-base">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 md:w-5 md:h-5 mr-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-3h-.75a2.25 2.25 0 00-2.25 2.25v1.5m0 0v1.5a2.25 2.25 0 002.25 2.25h.75m-2.25-3h-.75a2.25 2.25 0 00-2.25 2.25v1.5m0 0v1.5a2.25 2.25 0 002.25 2.25h.75m-6 3.75a2.25 2.25 0 012.25-2.25h1.5a2.25 0 012.25 2.25v1.5a2.25 0 01-2.25 2.25h-1.5a2.25 0 01-2.25-2.25v-1.5z" />
                                </svg>
                                Hiring
                            </div>
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-2 transform transition-transform duration-300" data-chevron-id="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                        <div id="dropdownMenu2" class="hidden bg-purple-500 text-white scrollable-dropdown">
                            <div data-action-key="Local Outreach" onclick="window.openModal('Local Outreach')" class="block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base">Local Outreach</div>
                            <div data-action-key="Online Websites" onclick="window.openModal('Online Websites')" class="block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base">Online Websites</div>
                            <div data-action-key="Recruiter" onclick="window.openModal('Recruiter')" class="block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base">Recruiter</div>
                            <div id="firePersonAction" data-action-key="Fire a Person" onclick="window.openModal('Fire a Person')" class="block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base">Fire a Person</div>
                        </div>
                    </div>
                    <div id="dropdown-3" class="relative">
                        <button onclick="window.openDropDown(3)" class="py-2 md:py-2.5 px-3 md:px-4 w-full flex items-center justify-between hover:bg-purple-500 transition-colors duration-150 text-sm md:text-base">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 md:w-5 md:h-5 mr-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a3 3 0 00-3-3H7.5a3 3 0 00-3 3v10.5a3 3 0 003 3h9a3 3 0 003-3V10.5M9 11.25h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v-.75a.75.75 0 01.75-.75zM13.5 11.25h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75H13.5a.75.75 0 01-.75-.75v-.75a.75.75 0 01.75-.75z" />
                                </svg>
                                Services
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-2 transform transition-transform duration-300" data-chevron-id="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                        <div id="dropdownMenu3" class="hidden bg-purple-500 text-white scrollable-dropdown">
                            <div onclick="window.openModal('Hire a Lawyer')" class="block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base">Hire a Lawyer</div>
                            <div onclick="window.openModal('Purchase Business Insurance')" class="block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base">Purchase Business Insurance</div>
                            <div onclick="window.openModal('Marketing Campaign')" class="block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base">Marketing Campaign</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden p-4">
            <div class="bg-slate-900 rounded-lg shadow-xl w-full max-w-md relative overflow-hidden modal-content-area">
                <div id="modalActionTitle" class="modal-title">Action Title</div>
                <button onclick="window.closeModal(false)" class="modal-close-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <p id="modalActionDescription" class="modal-description">Action description here.</p>
                <div id="modalActionCost" class="modal-cost">Cost: $XXX</div>
                <div id="modalActionSuccessChance" class="modal-success-chance">XX% chance of success</div>
                <div class="text-center pb-6">
                    <button onclick="window.closeModal(true)" class="modal-select-button">
                        SELECT
                    </button>
                </div>
            </div>
        </div>


        <div id="randomModal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden p-4">
            <div class="flex items-center justify-center h-full">
                <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-md p-5 md:p-6 text-white">
                    <h2 id="randomEventTitle" class="text-lg md:text-xl font-semibold mb-4 text-amber-400">Random Event</h2>
                    <p id="randomEventMessage" class="text-gray-300 mb-5 md:mb-6 text-sm md:text-base">This is the modal content.</p>
                    <div id="randomEventChoices" class="space-y-3 mb-4">
                        </div>
                    <div class="text-right">
                        <button id="randomEventConfirmButton" onclick="window.closeRandomModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm md:text-base transition-colors duration-150">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="quarterEndModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-slate-900 rounded-lg shadow-2xl w-full max-w-lg p-6 md:p-8 text-white finance-modal-text">
                <h2 id="quarterEndTitle" class="text-xl md:text-2xl font-bold mb-6 text-center text-purple-400">Year 1, Q1 Finances</h2>
                <div class="space-y-3 mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-green-400 mb-1">INCOME</h3>
                        <div class="flex justify-between border-b border-slate-700 py-1"><span>Sales</span><span id="qEndSales">$0</span></div>
                        <div class="flex justify-between border-b border-slate-700 py-1"><span>Actions & Events</span><span id="qEndActionIncome">$1,400</span></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-red-400 mb-1">EXPENSES</h3>
                        <div class="flex justify-between border-b border-slate-700 py-1"><span>Services</span><span id="qEndServiceCosts">$0</span></div>
                        <div class="flex justify-between border-b border-slate-700 py-1"><span>Rent</span><span id="qEndRent">-$0</span></div>
                        <div class="flex justify-between border-b border-slate-700 py-1"><span>Employee Wages</span><span id="qEndWages">$0</span></div>
                        <div class="flex justify-between border-b border-slate-700 py-1"><span>Actions & Events Cost</span><span id="qEndActionExpenses">-$3,100</span></div>
                        <div class="flex justify-between py-1"><span>Loan Repayment</span><span id="qEndLoanRepayment">-$900</span></div>
                    </div>
                </div>
                <div class="border-t-2 border-purple-500 pt-4 space-y-2">
                    <div class="flex justify-between text-lg">
                        <span class="font-semibold">NET PROFIT</span>
                        <span id="qEndNetProfit" class="font-bold">-$10,100</span>
                    </div>
                    <div class="flex justify-between text-xl">
                        <span class="font-semibold text-purple-300">CURRENT BALANCE</span>
                        <span id="qEndCurrentBalance" class="font-bold text-purple-300">$4,900</span>
                    </div>
                </div>
                <div class="text-center mt-8">
                    <button onclick="window.proceedToNextQuarter()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-8 py-3 rounded-lg text-lg transition-colors duration-150 shadow-md">
                        NEXT
                    </button>
                </div>
            </div>
        </div>

        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-5 md:p-6 text-white">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl md:text-2xl font-semibold text-sky-400">Game Settings</h2>
                    <button onclick="window.toggleSettingsModal()" class="text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-3">
                    <button onclick="window.confirmNewGame()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors duration-150">
                        Create New Game
                    </button>
                    <button onclick="window.loadGame()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors duration-150">
                        Load Game
                    </button>
                    </div>
            </div>
        </div>

        <div id="confirmNewGameModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-md p-5 md:p-6 text-white">
                <h2 class="text-lg md:text-xl font-semibold mb-4 text-amber-400">Start a New Venture?</h2>
                <p class="text-gray-300 mb-6 text-sm md:text-base">Ready to embark on a new venture? Your current progress will be erased and a new journey will begin!</p>
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                    <button onclick="window.handleStartNewWithoutSaving()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm md:text-base transition-colors duration-150">
                        Yes, Start Fresh!
                    </button>
                    <button onclick="window.closeConfirmNewGameModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm md:text-base transition-colors duration-150">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <div id="actionOutcomeModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-md p-5 md:p-6 text-white">
                <h2 id="actionOutcomeTitle" class="text-xl md:text-2xl font-semibold mb-4 text-center">Action Result</h2>
                <p id="actionOutcomeMessage" class="text-gray-300 mb-6 text-sm md:text-base text-center">Outcome message here.</p>
                <div class="text-center">
                    <button onclick="window.closeActionOutcomeModal()" class="bg-sky-500 hover:bg-sky-600 text-white px-6 py-2 rounded-md text-sm md:text-base transition-colors duration-150">
                        Continue
                    </button>
                </div>
            </div>
        </div>
    </div>
<script>
    // --- DOM Elements (constants, defined once DOM is ready) ---
    let companyHealthBar, marketDominationBar, customerSatisfactionBar, balancedBooksBar, 
        employeeCountDisplay, accountBalanceDisplay, businessIconDisplay, businessNameDisplay, 
        businessTypeDisplay, yearQuarterDisplay, actionPointsDisplay, actionsDropdown, 
        actionsChevron, modalBackdrop, modalActionTitle, modalActionDescription, 
        modalActionCost, modalActionSuccessChance, randomModal, randomModalTitle, randomEventMessage, randomEventChoices, randomEventConfirmButton,
        randomModalContent, quarterEndModal, qEndTitle, qEndSales, qEndActionIncome, 
        qEndServiceCosts, qEndRent, qEndWages, qEndActionExpenses, qEndLoanRepayment, 
        qEndNetProfit, qEndCurrentBalance, settingsModal, confirmNewGameModal, 
        actionOutcomeModal, actionOutcomeTitle, actionOutcomeMessage, 
        activityLog, mainElement, loadingScreen, contentWrapper, businessLocationDisplayElement; 

    function initializeDOMElements() {
        companyHealthBar = document.getElementById("companyHealthBar");
        marketDominationBar = document.getElementById("marketDominationBar");
        customerSatisfactionBar = document.getElementById("customerSatisfactionBar");
        balancedBooksBar = document.getElementById("balancedBooksBar"); 
        employeeCountDisplay = document.getElementById("employeeCount");
        accountBalanceDisplay = document.getElementById("accountBalance");
        businessIconDisplay = document.getElementById("businessIconDisplay");
        businessNameDisplay = document.getElementById("businessNameDisplay");
        businessTypeDisplay = document.getElementById("businessTypeDisplay");
        // businessLocationDisplayElement = document.getElementById("businessLocationDisplay"); // If you add this element to HTML
        yearQuarterDisplay = document.getElementById("yearQuarterDisplay");
        actionPointsDisplay = document.getElementById("actionPointsDisplay");
        actionsDropdown = document.getElementById("actionsDropdown");
        actionsChevron = document.getElementById("actionsChevron");
        modalBackdrop = document.getElementById('modalBackdrop');
        modalActionTitle = document.getElementById('modalActionTitle');
        modalActionDescription = document.getElementById('modalActionDescription');
        modalActionCost = document.getElementById('modalActionCost');
        modalActionSuccessChance = document.getElementById('modalActionSuccessChance');
        randomModal = document.getElementById('randomModal');
        randomModalTitle = document.getElementById('randomEventTitle'); 
        randomEventMessage = document.getElementById('randomEventMessage'); 
        randomEventChoices = document.getElementById('randomEventChoices'); 
        randomEventConfirmButton = document.getElementById('randomEventConfirmButton'); 
        quarterEndModal = document.getElementById('quarterEndModal');
        qEndTitle = document.getElementById('quarterEndTitle');
        qEndSales = document.getElementById('qEndSales');
        qEndActionIncome = document.getElementById('qEndActionIncome');
        qEndServiceCosts = document.getElementById('qEndServiceCosts');
        qEndRent = document.getElementById('qEndRent');
        qEndWages = document.getElementById('qEndWages');
        qEndActionExpenses = document.getElementById('qEndActionExpenses');
        qEndLoanRepayment = document.getElementById('qEndLoanRepayment');
        qEndNetProfit = document.getElementById('qEndNetProfit');
        qEndCurrentBalance = document.getElementById('qEndCurrentBalance');
        settingsModal = document.getElementById('settingsModal'); 
        confirmNewGameModal = document.getElementById('confirmNewGameModal'); 
        actionOutcomeModal = document.getElementById('actionOutcomeModal');
        actionOutcomeTitle = document.getElementById('actionOutcomeTitle');
        actionOutcomeMessage = document.getElementById('actionOutcomeMessage');
        activityLog = document.getElementById('activity-log');
        mainElement = document.querySelector('main');
        loadingScreen = document.getElementById('loading-screen'); 
        contentWrapper = document.querySelector('.content-wrapper'); 
    }


    // --- State Variables ---
    let actionsVisible = false;
    let openDropdownId = null;
    let latestActionKey = ""; 
    let currentModalType = "";
    let isSettingsModalVisible = false; 
    let currentRandomEventEffect = null; 
    let currentRandomEventIndex = -1; 


    // --- Initial Setup ---
    window.initializeUI = function() { 
        if (!businessIconDisplay) initializeDOMElements(); 

        icon = businessTypeIcons[businessType] || businessTypeIcons["Generic"];
        businessIconDisplay.textContent = icon;
        businessNameDisplay.textContent = businessName;
        businessTypeDisplay.textContent = businessType;
        // if (businessLocationDisplayElement) businessLocationDisplayElement.textContent = `Location: ${businessLocation}`;
        
        window.updateAllStatsDisplay(); 
        window.populateDropdown(); 
        window.resetQuarterlyFinances(); 
        window.updateActionCategoriesVisibility(); 
        window.updateHiringActionsState(); // Ensure hiring actions are correctly set on init
    }


    window.resetQuarterlyFinances = function() {
        quarterlySales = 0;
        quarterlyIncomeFromActionsAndEvents = 0;
        quarterlyExpensesFromActionsAndEvents = 0;
        quarterlyServiceCosts = 0;
    }


    // --- Update Functions ---
    window.updateActionPoints = function(cost) {
        actionPoints = Math.max(0, actionPoints - cost);
        actionPointsDisplay.textContent = actionPoints;
    }
    
    window.calculateCompanyHealth = function() {
        const balanceWeight = 0.50;
        const marketDominationWeight = 0.25;
        const customerSatisfactionWeight = 0.25;

        const minHealthyBalance = 0; 
        const targetHealthyBalance = 30000; 
        let balanceScore = ((balance - minHealthyBalance) / (targetHealthyBalance - minHealthyBalance)) * 100;
        balanceScore = Math.max(0, Math.min(100, balanceScore)); 

        const healthFromBalance = balanceScore * balanceWeight;
        const healthFromMarket = marketDominationPercentage * marketDominationWeight;
        const healthFromCustomer = customerSatisfactionPercentage * customerSatisfactionWeight;

        let calculatedBaseHealth = healthFromBalance + healthFromMarket + healthFromCustomer;
        return Math.max(0, Math.min(100, calculatedBaseHealth)); 
    }

    window.updateCompanyHealth = function() { 
        let baseHealth = window.calculateCompanyHealth();
        companyHealthPercentage = Math.max(0, Math.min(100, baseHealth + insuranceBonus));
        if(companyHealthBar) companyHealthBar.style.width = `${companyHealthPercentage}%`;
    }
    window.updateMarketDomination = function(value) {
        marketDominationPercentage = Math.max(0, Math.min(100, value));
        if(marketDominationBar) marketDominationBar.style.width = `${marketDominationPercentage}%`;
        window.updateCompanyHealth(); 
    }
    window.updateCustomerSatisfaction = function(value) {
        customerSatisfactionPercentage = Math.max(0, Math.min(100, value));
        if(customerSatisfactionBar) customerSatisfactionBar.style.width = `${customerSatisfactionPercentage}%`;
        window.updateCompanyHealth(); 
    }
    window.updateBalancedBooks = function(value) { 
        balancedBooksPercentage = Math.max(0, Math.min(100, value));
        if(balancedBooksBar) balancedBooksBar.style.width = `${balancedBooksPercentage}%`;
    }
    window.updateBalance = function(changeAmount, type = "other") { 
        balance += changeAmount;
        if(accountBalanceDisplay) accountBalanceDisplay.textContent = `$${balance.toLocaleString()}`;
        window.updateCompanyHealth(); 

        if (changeAmount > 0) { // Income
            if (type === "sales") {
                quarterlySales += changeAmount;
            } else if (type === "actionIncome" || type === "otherIncome") {
                 quarterlyIncomeFromActionsAndEvents += changeAmount;
            }
        } else if (changeAmount < 0) { // Expense
            if (type === "actionExpense" || type === "otherExpense" || type === "cost") { 
                quarterlyExpensesFromActionsAndEvents += Math.abs(changeAmount); 
            } else if (type === "serviceCost") { 
                quarterlyServiceCosts += Math.abs(changeAmount);
            }
        }
    }
    window.updateEmployeeCount = function(change) {
        employees += change;
        employees = Math.max(0, employees);
        if(employeeCountDisplay) employeeCountDisplay.textContent = employees;
        window.updateFireButtonState(); 
        window.updateHiringActionsState(); // Update hiring button states when employee count changes
    }
    window.updateYearQuarterDisplay = function() {
        if(yearQuarterDisplay) yearQuarterDisplay.textContent = `Year ${currentYear}, Q${currentQuarter}`;
    }

    window.updateAllStatsDisplay = function() {
        if(accountBalanceDisplay) accountBalanceDisplay.textContent = `$${balance.toLocaleString()}`;
        if(employeeCountDisplay) employeeCountDisplay.textContent = employees;
        if(actionPointsDisplay) actionPointsDisplay.textContent = actionPoints;
        if(marketDominationBar) marketDominationBar.style.width = `${marketDominationPercentage}%`;
        if(customerSatisfactionBar) customerSatisfactionBar.style.width = `${customerSatisfactionPercentage}%`;
        if(balancedBooksBar) balancedBooksBar.style.width = `${balancedBooksPercentage}%`;
        window.updateCompanyHealth(); 
        window.updateYearQuarterDisplay();
        window.updateFireButtonState(); 
        window.updateHiringActionsState();
    }

     window.updateFireButtonState = function() {
        const fireButton = document.getElementById('firePersonAction');
        if (fireButton) {
            if (employees === 0) {
                fireButton.classList.add('dropdown-item-disabled');
                fireButton.classList.remove('hover:bg-purple-400', 'cursor-pointer', 'dropdown-item-active');
                fireButton.onclick = null; 
            } else {
                fireButton.classList.remove('dropdown-item-disabled');
                fireButton.classList.add('hover:bg-purple-400', 'cursor-pointer', 'dropdown-item-active');
                fireButton.onclick = () => window.openModal('Fire a Person');
            }
        }
    }

    window.updateHiringActionsState = function() {
        const hiringActionKeys = ["Local Outreach", "Online Websites", "Recruiter"];
        let maxEmployeesForLocation = 0;
        switch(businessLocation) {
            case "Home-Based": maxEmployeesForLocation = MAX_EMPLOYEES_HOME_BASED; break;
            case "Physical Store": maxEmployeesForLocation = MAX_EMPLOYEES_PHYSICAL_STORE; break;
            case "Commercial Space": maxEmployeesForLocation = MAX_EMPLOYEES_COMMERCIAL_SPACE; break;
            default: maxEmployeesForLocation = MAX_EMPLOYEES_HOME_BASED;
        }

        const hiringDropdownMenu = document.getElementById('dropdownMenu2');
        if (!hiringDropdownMenu) return;

        hiringActionKeys.forEach(actionKey => {
            const actionDiv = hiringDropdownMenu.querySelector(`div[data-action-key="${actionKey}"]`);
            if (actionDiv) {
                const actionDetails = window.commonActions[actionKey]; // Hiring actions are common
                if (employees >= maxEmployeesForLocation) {
                    actionDiv.classList.add('dropdown-item-disabled');
                    actionDiv.classList.remove('hover:bg-purple-400', 'cursor-pointer', 'dropdown-item-active');
                    actionDiv.onclick = null; 
                } else {
                    actionDiv.classList.remove('dropdown-item-disabled');
                    actionDiv.classList.add('hover:bg-purple-400', 'cursor-pointer', 'dropdown-item-active');
                    actionDiv.onclick = () => window.openModal(actionKey);
                }
            }
        });
    }


    // --- Dropdown Logic ---
    window.toggleActions = function() {
        actionsVisible = !actionsVisible;
        actionsDropdown.classList.toggle("hidden", !actionsVisible);
        actionsChevron.classList.toggle("rotate-180", actionsVisible);

        if (!actionsVisible && openDropdownId !== null) {
            document.getElementById(`dropdownMenu${openDropdownId}`).classList.add('hidden');
            const chevron = document.querySelector(`button[onclick="window.openDropDown(${openDropdownId})"] svg[data-chevron-id]`);
            if (chevron) chevron.classList.remove('rotate-180');
            openDropdownId = null;
        }
    }

    window.openDropDown = function(n) {
        const currentDropdownMenu = document.getElementById(`dropdownMenu${n}`);
        const currentChevron = document.querySelector(`button[onclick="window.openDropDown(${n})"] svg[data-chevron-id]`);

        if (openDropdownId !== null && openDropdownId !== n) {
            document.getElementById(`dropdownMenu${openDropdownId}`).classList.add('hidden');
            const prevChevron = document.querySelector(`button[onclick="window.openDropDown(${openDropdownId})"] svg[data-chevron-id]`);
            if (prevChevron) prevChevron.classList.remove('rotate-180');
        }

        currentDropdownMenu.classList.toggle('hidden');
        if (currentChevron) currentChevron.classList.toggle('rotate-180', !currentDropdownMenu.classList.contains('hidden'));
        
        openDropdownId = currentDropdownMenu.classList.contains('hidden') ? null : n;
         if (n === 2) { // Hiring dropdown
            window.updateFireButtonState();
            window.updateHiringActionsState(); 
        }
    }

    // --- Modal Logic ---
    window.openModal = function(actionKey, type = 'action') { 
        latestActionKey = actionKey;
        currentModalType = type;

        const currentCategoryKey = businessTypeToCategoryMapping[businessType] || "2"; 
        const actionDetails = window.businessTypeActions[currentCategoryKey]?.[actionKey] || window.commonActions[actionKey];


        if (type === 'action' && actionDetails) {
            modalActionTitle.textContent = actionDetails.title || actionDetails.label;
            modalActionDescription.textContent = actionDetails.description || "Are you sure you want to perform this action?";
            modalActionCost.textContent = `Cost: $${actionDetails.financialCost.toLocaleString()}`;
            
            if (actionDetails.successChance !== null && actionDetails.successChance !== undefined) {
                modalActionSuccessChance.textContent = `${actionDetails.successChance}% chance of success`;
                modalActionSuccessChance.classList.remove('hidden');
            } else {
                modalActionSuccessChance.classList.add('hidden');
            }
            
            modalBackdrop.classList.remove('hidden');

        } else if (type === 'randomEvent') { 
            // Handled by triggerRandomEvent
        }
        
        if (actionsVisible) {
            window.toggleActions(); 
        }
    }

    window.closeModal = function(performAction) {
        modalBackdrop.classList.add('hidden');
        if (performAction && currentModalType === 'action') {
            window.handleAction(latestActionKey); 
        }
        latestActionKey = ""; 
        currentModalType = "";
    }
    
    window.closeRandomModal = function() {
        if (currentRandomEventEffect) {
            currentRandomEventEffect(); 
            currentRandomEventEffect = null; 
        }
        randomModal.classList.add('hidden');
        randomEventChoices.innerHTML = ''; 
        randomEventConfirmButton.classList.remove('hidden'); 
        window.updateAllStatsDisplay();
    }

    window.showActionOutcome = function(title, message, type) {
        actionOutcomeTitle.textContent = title;
        actionOutcomeMessage.textContent = message;
        
        actionOutcomeTitle.classList.remove('modal-title-success', 'modal-title-failure', 'modal-title-neutral');
        if (type === 'bonus') {
            actionOutcomeTitle.classList.add('modal-title-success');
        } else if (type === 'penalty') {
            actionOutcomeTitle.classList.add('modal-title-failure');
        } else {
            actionOutcomeTitle.classList.add('modal-title-neutral');
        }
        actionOutcomeModal.classList.remove('hidden');
    }

    window.closeActionOutcomeModal = function() {
        actionOutcomeModal.classList.add('hidden');

        if (actionPoints === 0 && quarterEndModal.classList.contains('hidden')) {
            window.showQuarterEndModal();
        } 
        else if (actionPoints === 3 && ((currentYear > 1) || (currentYear === 1 && currentQuarter > 2)) && Math.random() < 0.25) { 
            window.triggerRandomEvent();
        }
    }


    window.showQuarterEndModal = function() {
        window.businessLog(`End of Q${currentQuarter}, Year ${currentYear}. Reviewing finances.`, "system");
        qEndTitle.textContent = `Year ${currentYear}, Q${currentQuarter} Finances`;
        
        const employeeGeneratedSales = employees * SALES_PER_EMPLOYEE_PER_QUARTER;
        window.updateBalance(employeeGeneratedSales, "sales"); 

        const currentQuarterSalaries = employees * SALARY_PER_EMPLOYEE_PER_QUARTER;
        
        let currentRentForQuarter = 0;
        switch(businessLocation) {
            case "Home-Based":
                currentRentForQuarter = RENT_HOME_BASED;
                break;
            case "Physical Store":
                currentRentForQuarter = RENT_PHYSICAL_STORE;
                break;
            case "Commercial Space":
                currentRentForQuarter = RENT_COMMERCIAL_SPACE;
                break;
            default:
                currentRentForQuarter = RENT_HOME_BASED; // Default to home-based if undefined
        }

        if (!fixedExpensesAppliedForQuarter) { 
            window.updateBalance(-currentQuarterSalaries, "salary"); 
            window.updateBalance(-currentRentForQuarter, "rent");  
            window.updateBalance(-LOAN_REPAYMENT_PER_QUARTER, "loan"); 
            fixedExpensesAppliedForQuarter = true;
        }

        qEndSales.textContent = `$${quarterlySales.toLocaleString()}`;
        qEndActionIncome.textContent = `$${quarterlyIncomeFromActionsAndEvents.toLocaleString()}`;
        qEndServiceCosts.textContent = `-$${quarterlyServiceCosts.toLocaleString()}`;
        qEndRent.textContent = `-$${currentRentForQuarter.toLocaleString()}`;
        qEndWages.textContent = `-$${currentQuarterSalaries.toLocaleString()}`;
        qEndActionExpenses.textContent = `-$${quarterlyExpensesFromActionsAndEvents.toLocaleString()}`; 
        qEndLoanRepayment.textContent = `-$${LOAN_REPAYMENT_PER_QUARTER.toLocaleString()}`;

        const totalIncome = quarterlySales + quarterlyIncomeFromActionsAndEvents;
        const totalExplicitExpenses = quarterlyServiceCosts + currentRentForQuarter + currentQuarterSalaries + quarterlyExpensesFromActionsAndEvents + LOAN_REPAYMENT_PER_QUARTER;
        const totalNetProfitThisQuarter = totalIncome - totalExplicitExpenses;

        qEndNetProfit.textContent = `$${totalNetProfitThisQuarter.toLocaleString()}`; 
        qEndNetProfit.className = totalNetProfitThisQuarter >= 0 ? 'font-bold text-green-400' : 'font-bold text-red-400';
        qEndCurrentBalance.textContent = `$${balance.toLocaleString()}`; 
        quarterEndModal.classList.remove('hidden');
    }
    let fixedExpensesAppliedForQuarter = false; 

    window.proceedToNextQuarter = function() {
        quarterEndModal.classList.add('hidden');
        window.advanceQuarter();
    }

    // --- Settings Modal Logic ---
    window.toggleSettingsModal = function() {
        isSettingsModalVisible = !isSettingsModalVisible;
        settingsModal.classList.toggle('hidden', !isSettingsModalVisible);
        if (isSettingsModalVisible) {
            window.businessLog("Opened game settings.", "system");
        }
    }

    window.confirmNewGame = function() {
        window.toggleSettingsModal(); 
        confirmNewGameModal.classList.remove('hidden'); 
    }

    window.closeConfirmNewGameModal = function() {
        confirmNewGameModal.classList.add('hidden');
    }
    
    window.handleStartNewWithoutSaving = function() { 
        window.businessLog("Starting new game. Current progress will be lost.", "system");
        window.closeConfirmNewGameModal();
        
        businessName = "Stellar Innovations"; 
        businessType = "Web Development Services"; 
        businessLocation = "Home-Based"; // Reset to default location
        
        companyHealthPercentage = 50; 
        marketDominationPercentage = 50;
        customerSatisfactionPercentage = 50;
        balancedBooksPercentage = 50;
        employees = 0;
        balance = 15000; 
        currentYear = 1;
        currentQuarter = 1;
        actionPoints = 4;
        insuranceBonus = 0;
        currentSoftwareDevelopmentStageIndex = 0; 
        productV1Launched = false; 
        currentCategory2StageIndex = 0; 
        fixedExpensesAppliedForQuarter = false;
        if(activityLog) activityLog.innerHTML = ""; 

        window.initializeUI(); 
        window.intro(); 
    }
    
    window.saveGame = function() { 
        window.businessLog("Save Game: Functionality not yet implemented.", "system");
    }

    window.loadGame = async function() { 
        window.businessLog("Attempting to load game data...", "system");
        if(settingsModal && !settingsModal.classList.contains('hidden')) { 
            window.toggleSettingsModal(); 
        }
        
        const loadSuccessful = await fetchUserData(); 

        if (loadSuccessful) {
            window.businessLog("Game data loaded successfully.", "system");
        } else {
            window.businessLog("Failed to load existing game data or no data found. Using default values.", "system");
            balance = 15000;
            companyHealthPercentage = 50;
            businessLocation = "Home-Based"; // Ensure default if not loaded
        }
        window.initializeUI(); 
    };


    // --- Activity Log ---
    window.businessLog = function(actionText, type = "action") {
        if (!activityLog) return; 
        const newEntry = document.createElement("div");
        let bgColor = "bg-amber-400"; let textColor = "text-amber-900"; 
        
        if (type === "bonus") {
            bgColor = "bg-green-400"; textColor = "text-green-900";
        } else if (type === "penalty") {
            bgColor = "bg-red-400"; textColor = "text-red-900";
        } else if (type === "system") {
            bgColor = "bg-gray-400"; textColor = "text-gray-900";
        } else if (type === "event") { 
            bgColor = "bg-sky-400"; textColor = "text-sky-900";
        }

        newEntry.className = `${bgColor} ${textColor} p-2 md:p-3 rounded-md text-xs md:text-sm shadow`;
        newEntry.textContent = actionText; 
        activityLog.prepend(newEntry);
        if (activityLog.children.length > 10) activityLog.removeChild(activityLog.lastChild);
    }

    // --- Action Handling ---
    window.handleAction = function(actionKey){ 
        const currentCategoryKey = businessTypeToCategoryMapping[businessType] || "2";
        const actionDetails = window.businessTypeActions[currentCategoryKey]?.[actionKey] || window.commonActions[actionKey];

        if (!actionDetails) {
            window.businessLog(`Error: Action "${actionKey}" not found for category ${currentCategoryKey} or common.`, "penalty");
            return;
        }

        // Check for employee capacity before processing hiring actions
        if (actionDetails.effects && actionDetails.effects.success && actionDetails.effects.success.employeeGain && actionDetails.effects.success.employeeGain > 0) {
            let maxEmployeesForLocation = 0;
            switch(businessLocation) {
                case "Home-Based": maxEmployeesForLocation = MAX_EMPLOYEES_HOME_BASED; break;
                case "Physical Store": maxEmployeesForLocation = MAX_EMPLOYEES_PHYSICAL_STORE; break;
                case "Commercial Space": maxEmployeesForLocation = MAX_EMPLOYEES_COMMERCIAL_SPACE; break;
                default: maxEmployeesForLocation = MAX_EMPLOYEES_HOME_BASED; 
            }

            if (employees >= maxEmployeesForLocation) {
                window.businessLog(`Cannot hire: Location capacity (${maxEmployeesForLocation}) reached for ${businessLocation}.`, "system");
                window.showActionOutcome("Hiring Blocked", `Your ${businessLocation} location can only support ${maxEmployeesForLocation} employees. You cannot hire more at this time. Consider upgrading your location.`, "system");
                return; // Exit handleAction early, no AP/cost deduction
            }
        }


        if (actionKey === "Fire a Person" && employees === 0) {
            window.businessLog("Cannot fire: No employees.", "system");
             window.showActionOutcome("Operation Update", "No employees to fire.", "system");
            return; 
        }


        if (actionPoints < actionDetails.apCost && !(actionKey === "Fire a Person" && actionDetails.apCost <= actionPoints) ) {
            window.businessLog("Not enough action points for: " + actionDetails.label, "penalty");
            randomModalTitle.textContent = "No Action Points";
            randomEventMessage.textContent = "You don't have enough action points for this.";
            randomEventChoices.innerHTML = ''; 
            randomEventConfirmButton.classList.remove('hidden');
            currentRandomEventEffect = null; 
            randomModal.classList.remove('hidden');
            return;
        }
        if (balance < actionDetails.financialCost) {
            window.businessLog("Not enough funds for: " + actionDetails.label, "penalty");
            randomModalTitle.textContent = "Insufficient Funds";
            randomEventMessage.textContent = `You need $${actionDetails.financialCost.toLocaleString()} for this action.`;
            randomEventChoices.innerHTML = '';
            randomEventConfirmButton.classList.remove('hidden');
            currentRandomEventEffect = null;
            randomModal.classList.remove('hidden');
            return;
        }

        let currentApCost = actionDetails.apCost || 0; 
        let currentFinancialCost = actionDetails.financialCost || 0;
        let outcomeTitle = "";
        let outcomeMessage = ""; 
        let balanceChange = -currentFinancialCost; 
        let balanceChangeType = "actionExpense"; 

        if (currentFinancialCost === 0 && actionDetails.effects?.success?.balanceGain > 0) {
             balanceChangeType = "actionIncome"; 
        } else if (currentFinancialCost > 0) {
            if (actionKey === "Purchase Business Insurance" || actionKey === "Hire a Lawyer" || actionKey === "Marketing Campaign") {
                balanceChangeType = "serviceCost";
            } else {
                balanceChangeType = "actionExpense";
            }
        }


        let outcomeType = "action"; 
        let success = true; 

        if (actionDetails.successChance !== null && actionDetails.successChance !== undefined) {
            success = Math.random() < (actionDetails.successChance / 100);
        }

        const effects = success ? actionDetails.effects.success : actionDetails.effects.failure;
        
        outcomeMessage = effects.message;
        if (currentFinancialCost > 0 && !(effects.balanceGain && effects.balanceGain > 0 && success)) { 
            outcomeMessage += ` (-$${currentFinancialCost.toLocaleString()})`;
        }


        outcomeType = success ? "bonus" : "penalty";
        outcomeTitle = success ? "Success!" : "Failure!";


        if (effects.csChange) window.updateCustomerSatisfaction(customerSatisfactionPercentage + effects.csChange);
        if (effects.mdChange) window.updateMarketDomination(marketDominationPercentage + effects.mdChange);
        if (effects.healthChange) { 
            companyHealthPercentage = Math.max(0, Math.min(100, companyHealthPercentage + effects.healthChange));
        }
        if (effects.lpChange) window.updateBalancedBooks(balancedBooksPercentage + effects.lpChange);
        if (effects.balanceGain) {
            balanceChange += effects.balanceGain; 
            if(effects.balanceGain > 0) balanceChangeType = "actionIncome"; 
        }
        if (effects.employeeGain) window.updateEmployeeCount(effects.employeeGain);
        if (actionKey === "Purchase Business Insurance" && success && effects.applyInsuranceBonus) {
            insuranceBonus = 15; 
        }


        // Sequential logic & Cycle Reset
        if (actionDetails.isSequential) {
            if (currentCategoryKey === "1") {
                if (success) {
                    if (actionKey === "Launch: Launch your product") {
                        productV1Launched = true;
                        currentSoftwareDevelopmentStageIndex++; 
                    } else if (currentSoftwareDevelopmentStageIndex === category1StageOrder.indexOf(actionKey)) {
                        currentSoftwareDevelopmentStageIndex++;
                    }
                }
            } else if (currentCategoryKey === "2") { 
                if (success && currentCategory2StageIndex === category2StageOrder.indexOf(actionKey)) {
                    if (actionKey === "Offer Discount") { 
                        currentCategory2StageIndex = 0; 
                    } else {
                        currentCategory2StageIndex++; 
                    }
                }
            }
        } else if (actionKey === "Announce new product/version" && currentCategoryKey === "1") { 
            if (customerSatisfactionPercentage > 60) { 
                outcomeMessage = actionDetails.effects.success.message + (currentFinancialCost > 0 ? ` (-$${currentFinancialCost.toLocaleString()})` : "");
                if(actionDetails.effects.success.csChange) window.updateCustomerSatisfaction(customerSatisfactionPercentage + actionDetails.effects.success.csChange);
                if(actionDetails.effects.success.mdChange) window.updateMarketDomination(marketDominationPercentage + actionDetails.effects.success.mdChange);
                outcomeType = "bonus";
                currentSoftwareDevelopmentStageIndex = 0; 
            } else { 
                outcomeMessage = actionDetails.effects.failure.message + (currentFinancialCost > 0 ? ` (-$${currentFinancialCost.toLocaleString()})` : "");
                if(actionDetails.effects.failure.csChange) window.updateCustomerSatisfaction(customerSatisfactionPercentage + actionDetails.effects.failure.csChange);
                outcomeType = "penalty";
            }
        }
        
        if (balanceChange !== 0) { 
            window.updateBalance(balanceChange, balanceChangeType);
        }

        window.businessLog(outcomeMessage, outcomeType); 
        window.showActionOutcome(outcomeTitle, outcomeMessage, outcomeType); 
        
        if (currentApCost > 0) { 
            window.updateActionPoints(currentApCost); 
        }
        window.updateAllStatsDisplay(); 
        window.populateDropdown(); 
    }

    // --- Background and Dynamic Content ---
    window.changeBackgroundAndContent = function(themeNumber) {
        const mainContentHeader = document.getElementById('mainContentHeader');
        const mainContentSubtext = document.getElementById('mainContentSubtext');
        let bgImage = `url('{% static 'mod4bg.gif' %}')`; 
        let headerText = 'Welcome to the Project Ideation Journey';
        let subText = 'Start your business simulation by selecting an option from the sidebar. Good luck!'; 

        mainElement.style.backgroundColor = ''; 

        if (themeNumber === 0) { // Intro
            bgImage = `url('{% static 'mod4bg.gif' %}')`; 
            headerText = 'Welcome to Your New Business Adventure!';
            subText = 'The journey begins now. Your first task is to research potential customers. Good luck!';
        } else if (themeNumber === 1) { // Category 1 - Product Dev
            bgImage = `url('{% static 'mod4bg.gif' %}')`; 
            headerText = "Product Development Lifecycle"; 
            subText = "Navigate the stages of product creation, from research to launch.";
        } else if (themeNumber === 2) { // Category 2 - Service/Retail
            bgImage = `url('{% static 'mod4bg1.gif' %}')`; 
            headerText = "Service & Operations Focus"; 
            subText = "Manage day-to-day tasks and grow your customer base.";
        } else { // Default/Error theme
            mainElement.style.backgroundImage = ''; 
            mainElement.style.backgroundColor = '#7f1d1d'; 
            headerText = "Critical Decisions Ahead";
            subText = "Navigate challenges and make tough choices for your business.";
            bgImage = 'none'; 
        }
        
        if (bgImage === 'none') {
            mainElement.style.backgroundImage = '';
        } else {
            mainElement.style.backgroundImage = bgImage;
        }
        mainContentHeader.textContent = headerText;
        mainContentSubtext.textContent = subText;
    }
    
    // --- Dropdown Content Population ---
    window.populateDropdown = function() { 
        const dropdownMenu = document.getElementById("dropdownMenu1"); 
        if (!dropdownMenu) return; 
        dropdownMenu.innerHTML = ""; 

        const currentCategoryKey = businessTypeToCategoryMapping[businessType] || "2";
        const currentActionsForCategory = window.businessTypeActions[currentCategoryKey] || {};

        if (window.location.hash !== "#introActive") { 
            let currentThemeForPopulation = (currentCategoryKey === "1") ? 1 : 2;
            window.changeBackgroundAndContent(currentThemeForPopulation);
        }

        if (currentCategoryKey === "1") {
            category1StageOrder.forEach((actionKey, index) => {
                const item = currentActionsForCategory[actionKey];
                if (item) {
                    const div = document.createElement("div");
                    div.className = "block px-4 py-2 transition-colors duration-150 text-sm md:text-base";
                    div.textContent = item.label;

                    if (index === currentSoftwareDevelopmentStageIndex && currentSoftwareDevelopmentStageIndex < category1StageOrder.length) {
                        // Current active step in the cycle (either V1 or V-Next)
                        div.classList.add("dropdown-item-active", "hover:bg-purple-400", "cursor-pointer");
                        div.onclick = () => window.openModal(item.actionKey);
                    } else if (index < currentSoftwareDevelopmentStageIndex || (productV1Launched && actionKey === "Launch: Launch your product" && currentSoftwareDevelopmentStageIndex === 0) ) {
                        // Stages before the current active stage are completed for *this* cycle
                        // OR if V1 is launched and we've reset to research (index 0), "Launch Product" from V1 cycle is considered completed.
                        // This second condition for "Launch Product" ensures it shows as completed if we are in a V-Next cycle.
                         if (productV1Launched && actionKey === "Launch: Launch your product" && currentSoftwareDevelopmentStageIndex === 0) {
                             div.classList.add("dropdown-item-completed");
                         } else if (index < currentSoftwareDevelopmentStageIndex) {
                            div.classList.add("dropdown-item-completed");
                         } else { // Should not happen with this logic, but as a fallback
                            div.classList.add("dropdown-item-disabled");
                         }
                    }
                     else { // index > currentSoftwareDevelopmentStageIndex OR cycle is complete (currentSoftwareDevelopmentStageIndex >= category1StageOrder.length)
                        div.classList.add("dropdown-item-disabled");
                    }
                    dropdownMenu.appendChild(div);
                }
            });

            const announceActionKey = "Announce new product/version";
            const announceItemDetails = currentActionsForCategory[announceActionKey];
            if (announceItemDetails && productV1Launched && currentSoftwareDevelopmentStageIndex >= category1StageOrder.length) { 
                // Only show "Announce" if V1 is launched AND all V1 stages are done.
                const div = document.createElement("div");
                div.className = "block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base dropdown-item-active";
                div.textContent = announceItemDetails.label;
                div.onclick = () => window.openModal(announceItemDetails.actionKey);
                dropdownMenu.appendChild(div);
            }

            Object.values(currentActionsForCategory).forEach(item => {
                if (item.isAlwaysAvailable && 
                    !category1StageOrder.includes(item.actionKey) && 
                    item.actionKey !== announceActionKey) {
                    const div = document.createElement("div");
                    div.className = "block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base dropdown-item-active";
                    div.textContent = item.label;
                    div.onclick = () => window.openModal(item.actionKey);
                    dropdownMenu.appendChild(div);
                }
            });
        } else if (currentCategoryKey === "2") { 
            category2StageOrder.forEach((actionKey, index) => {
                const item = currentActionsForCategory[actionKey];
                if (item) {
                    const div = document.createElement("div");
                    div.className = "block px-4 py-2 transition-colors duration-150 text-sm md:text-base";
                    div.textContent = item.label;

                    if (index === currentCategory2StageIndex) {
                        div.classList.add("dropdown-item-active", "hover:bg-purple-400", "cursor-pointer");
                        div.onclick = () => window.openModal(item.actionKey);
                    } else if (index < currentCategory2StageIndex) {
                        div.classList.add("dropdown-item-completed");
                    } else { 
                        div.classList.add("dropdown-item-disabled");
                    }
                    dropdownMenu.appendChild(div);
                }
            });
             Object.values(currentActionsForCategory).forEach(item => {
                if (!category2StageOrder.includes(item.actionKey) && 
                    !window.commonActions[item.actionKey] && 
                     item.isAlwaysAvailable 
                   ) {
                        const div = document.createElement("div");
                        div.className = "block px-4 py-2 hover:bg-purple-400 transition-colors duration-150 cursor-pointer text-sm md:text-base dropdown-item-active";
                        div.textContent = item.label;
                        div.onclick = () => window.openModal(item.actionKey);
                        dropdownMenu.appendChild(div);
                }
            });
        }
    }

    // --- Random Events ---
    const randomEvents = [
        { 
            title: "Local Bowling Team Sponsorship", 
            message: "The VERY popular local bowling team asks you to sponsor their uniforms. It‚Äôs costly, but it‚Äôs great publicity and positive association with a beloved team.",
            type: 'choice', 
            choices: [
                { 
                    buttonText: "Sponsor Team (-$3,000)", 
                    cost: -3000, 
                    effectText: "Sponsored the bowling team! Great publicity. MD +5, CS +3.",
                    effect: () => { 
                        window.updateBalance(-3000, "cost"); 
                        window.updateMarketDomination(marketDominationPercentage + 5);
                        window.updateCustomerSatisfaction(customerSatisfactionPercentage + 3);
                    } 
                },
                { 
                    buttonText: "Decline Sponsorship", 
                    cost: 0, 
                    effectText: "Declined sponsorship. You didn't support the community. CS -2.",
                    effect: () => { 
                        window.updateCustomerSatisfaction(customerSatisfactionPercentage - 2);
                    } 
                }
            ]
        },
        { 
            title: "Paperwork Error!", 
            message: "You should pay more attention when filing important paperwork! Wow, that was unexpected‚Ä¶ Your mistake led to an unexpected refund.",
            type: 'simple',
            cost: 1000, 
            effectText: "Unexpected refund of $1,000 due to a paperwork error! LP +5.",
            effect: () => { 
                window.updateBalance(1000, "otherIncome"); 
                window.updateBalancedBooks(balancedBooksPercentage + 5);
            } 
        },
        { 
            title: "Busted Pipe!", 
            message: "A busted pipe leaked overnight, and the entire place is flooded. It doesn‚Äôt look like you have insurance‚Ä¶ This is going to cost you big time.",
            type: 'simple',
            cost: -7500, 
            effectText: "Busted pipe cost $7,500 to repair. Company Health -10.",
            effect: () => { 
                window.updateBalance(-7500, "cost"); 
                companyHealthPercentage = Math.max(0, companyHealthPercentage -10);
                window.updateCompanyHealth(); 
            } 
        },
        {
            title: "Top Hat Investment",
            message: "A lawyer has reached out to you on behalf of an anonymous party. They want to invest $2,000 but only if you wear a top hat for the rest of the quarter.",
            type: 'choice',
            choices: [
                {
                    buttonText: "Wear Top Hat (+$2,000)",
                    cost: 2000, 
                    effectText: "Congrats! You got $2,000 in the bank AND look very fancy. CS +1.",
                    effect: () => { window.updateBalance(2000, "otherIncome"); window.updateCustomerSatisfaction(customerSatisfactionPercentage + 1); }
                },
                {
                    buttonText: "Decline Offer",
                    cost: 0,
                    effectText: "You declined the top hat offer and didn't receive the $2,000.",
                    effect: () => {}
                }
            ]
        },
        {
            title: "Bird Roost!",
            message: "Hundreds of birds have taken roost outside your place of business. Why are there so many?!",
            type: 'choice',
            choices: [
                {
                    buttonText: "Play Loud Acid Jazz (-$1,500)",
                    cost: -1500,
                    effectText: "Played Acid Jazz. Now there are more birds. Should have known birds love acid jazz. Cost $1,500. CS -3.",
                    effect: () => { window.updateBalance(-1500, "cost"); window.updateCustomerSatisfaction(customerSatisfactionPercentage -3); }
                },
                {
                    buttonText: "Accept the Birds",
                    cost: 0,
                    effectText: "You're one with the birds, man. The community is loving your new avian friends! CS +5.",
                    effect: () => { window.updateCustomerSatisfaction(customerSatisfactionPercentage + 5); }
                }
            ]
        }
    ];


    window.triggerRandomEvent = function() {
        currentRandomEventIndex = Math.floor(Math.random() * randomEvents.length);
        const event = randomEvents[currentRandomEventIndex];

        randomModalTitle.textContent = event.title;
        randomEventMessage.textContent = event.message;
        randomEventChoices.innerHTML = ''; 

        if (event.type === 'simple') {
            randomEventConfirmButton.classList.remove('hidden');
            currentRandomEventEffect = () => { 
                if (event.cost && typeof event.cost === 'number') { 
                     window.updateBalance(event.cost, event.cost > 0 ? "otherIncome" : "cost");
                }
                event.effect(); 
                window.businessLog(event.effectText, (event.cost && event.cost >= 0) ? "bonus" : "penalty");
            };
        } else if (event.type === 'choice') {
            randomEventConfirmButton.classList.add('hidden'); 
            event.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-150 mb-2';
                button.textContent = choice.buttonText;
                button.onclick = () => window.handleRandomEventChoice(currentRandomEventIndex, index);
                randomEventChoices.appendChild(button);
            });
        }
        randomModal.classList.remove('hidden');
    }

    window.handleRandomEventChoice = function(eventIdx, choiceIdx) {
        const event = randomEvents[eventIdx];
        const choice = event.choices[choiceIdx];

        if (choice.cost && typeof choice.cost === 'number') { 
            window.updateBalance(choice.cost, choice.cost > 0 ? "otherIncome" : "cost");
        }
        choice.effect();
        window.businessLog(choice.effectText, (choice.cost && choice.cost > 0) ? "bonus" : (choice.cost < 0 ? "penalty" : "event"));
        
        randomModal.classList.add('hidden');
        randomEventChoices.innerHTML = ''; 
        randomEventConfirmButton.classList.remove('hidden'); 
        window.updateAllStatsDisplay();
        currentRandomEventEffect = null; 
    }

    // --- Intro Function ---
    window.intro = function() {
        console.log("Executing intro function...");
        window.location.hash = "introActive"; 
        window.changeBackgroundAndContent(0); 
        window.location.hash = ""; 

        window.businessLog("Welcome! Your new business journey starts now. Your first step is Research.", "system");
    }


    // --- Game Loop / Turn Advancement ---
    window.advanceQuarter = function() {
        currentQuarter++;
        if (currentQuarter > 4) {
            currentQuarter = 1;
            currentYear++;
        }
        actionPoints = 4; 
        fixedExpensesAppliedForQuarter = false; 
        window.resetQuarterlyFinances(); 

        window.updateCustomerSatisfaction(customerSatisfactionPercentage - Math.floor(Math.random() * 3 + 1)); 
        window.updateMarketDomination(marketDominationPercentage - Math.floor(Math.random() * 2)); 

        window.businessLog(`Advanced to Year ${currentYear}, Q${currentQuarter}. Action points reset.`, "system");
        window.updateAllStatsDisplay(); 
        window.populateDropdown(); 
        window.updateActionCategoriesVisibility(); 

        if (actionPoints === 3 && ((currentYear > 1) || (currentYear === 1 && currentQuarter > 2)) && Math.random() < 0.3) { 
            window.triggerRandomEvent();
        }
    }
    
    window.updateActionCategoriesVisibility = function() {
        const hiringDropdownContainer = document.getElementById('dropdown-2');
        const servicesDropdownContainer = document.getElementById('dropdown-3');

        if (currentYear === 1 && currentQuarter === 1) {
            if(hiringDropdownContainer) hiringDropdownContainer.classList.add('hidden');
            if(servicesDropdownContainer) servicesDropdownContainer.classList.add('hidden');
        } else {
            if(hiringDropdownContainer) hiringDropdownContainer.classList.remove('hidden');
            if(servicesDropdownContainer) servicesDropdownContainer.classList.remove('hidden');
        }
    }

    // --- Event Listeners & Initialization ---
    
    window.onload = async function() {
        initializeDOMElements(); 

        if(loadingScreen) loadingScreen.classList.remove('hidden');
        if(contentWrapper) contentWrapper.style.display = 'none';
        document.body.style.overflow = 'hidden';

        await window.loadGame(); 

        if(loadingScreen) loadingScreen.classList.add('hidden');
        if(contentWrapper) contentWrapper.style.display = 'flex'; 
        document.body.style.overflow = 'auto'; 
        
        if (businessName === "Stellar Innovations" && 
            businessType === "Web Development Services" &&
            balance === 15000 && 
            currentYear === 1 && 
            currentQuarter === 1 &&
            companyHealthPercentage === 50 && 
            (!activityLog || activityLog.innerHTML.trim() === "")) { 
            window.intro();
        }
    };


    document.addEventListener('click', function(event) {
        const actionsButton = document.querySelector('button[onclick="window.toggleActions()"]');
        const isClickInsideActionsButton = actionsButton ? actionsButton.contains(event.target) : false;
        const isClickInsideActionsDropdown = actionsDropdown ? actionsDropdown.contains(event.target) : false;
        const settingsButton = document.querySelector('button[onclick="window.toggleSettingsModal()"]');
        const isClickInsideSettingsButton = settingsButton ? settingsButton.contains(event.target) : false;
        const isClickInsideSettingsModal = settingsModal ? settingsModal.contains(event.target) : false;
        const isClickInsideConfirmNewGameModal = confirmNewGameModal ? confirmNewGameModal.contains(event.target) : false;
        
        if (!isClickInsideActionsButton && !isClickInsideActionsDropdown && actionsVisible) {
            window.toggleActions(); 
        } else if (openDropdownId !== null) {
            const specificDropdownContainer = document.getElementById(`dropdown-${openDropdownId}`);
            const specificDropdownMenu = document.getElementById(`dropdownMenu${openDropdownId}`);
            const isClickInsideSpecificDropdown = (specificDropdownContainer && specificDropdownContainer.contains(event.target)) || 
                                                 (specificDropdownMenu && specificDropdownMenu.contains(event.target)) ||
                                                 (event.target.closest(`button[onclick="window.openDropDown(${openDropdownId})"]`));

            if (!isClickInsideSpecificDropdown && !isClickInsideActionsButton) {
                 const dropdownMenuToClose = document.getElementById(`dropdownMenu${openDropdownId}`);
                 const chevronToReset = document.querySelector(`button[onclick="window.openDropDown(${openDropdownId})"] svg[data-chevron-id]`);
                 if (dropdownMenuToClose && !dropdownMenuToClose.classList.contains('hidden')) {
                                         dropdownMenuToClose.classList.add('hidden');
                                         if(chevronToReset) chevronToReset.classList.remove('rotate-180');
                                         openDropdownId = null;
                 }
            }
        }

        if (!isClickInsideSettingsButton && !isClickInsideSettingsModal && isSettingsModalVisible) {
            window.toggleSettingsModal();
        }
    });

    async function fetchUserData() {
        const apiUrl = 'get_business_data/'; 
        console.log("Fetching user data from:", apiUrl);

        try {
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            if (!response.ok) {
                let errorData = { error: `HTTP error! Status: ${response.status}`};
                try {
                    errorData = await response.json(); 
                } catch (e) {
                    errorData.error = response.statusText;
                }
                console.error('Network response was not ok:', response.status, errorData);
                businessLog(`Error fetching data: ${errorData.error || response.statusText}`, "penalty");
                return false; 
            }

            const data = await response.json();
            console.log("Fetched data from backend:", data); 

            if (data.businesses && data.businesses.length > 0) {
                const fetchedBusiness = data.businesses[0];

                businessName = fetchedBusiness.business_name !== undefined ? fetchedBusiness.business_name : businessName;
                businessType = fetchedBusiness.business_type !== undefined ? fetchedBusiness.business_type : businessType;
                businessLocation = fetchedBusiness.business_location !== undefined ? fetchedBusiness.business_location : "Home-Based"; // Load location
                
                balance = 15000; 
                
                if (fetchedBusiness.market_domination !== undefined) marketDominationPercentage = fetchedBusiness.market_domination;
                if (fetchedBusiness.customer_satisfaction !== undefined) customerSatisfactionPercentage = fetchedBusiness.customer_satisfaction;
                if (fetchedBusiness.balanced_books !== undefined) balancedBooksPercentage = fetchedBusiness.balanced_books;
                if (fetchedBusiness.employees_count !== undefined) employees = fetchedBusiness.employees_count;
                if (fetchedBusiness.current_year !== undefined) currentYear = fetchedBusiness.current_year;
                if (fetchedBusiness.current_quarter !== undefined) currentQuarter = fetchedBusiness.current_quarter;
                if (fetchedBusiness.action_points !== undefined) actionPoints = fetchedBusiness.action_points;
                if (fetchedBusiness.insurance_bonus !== undefined) insuranceBonus = fetchedBusiness.insurance_bonus;
                if (fetchedBusiness.product_v1_launched !== undefined) productV1Launched = fetchedBusiness.product_v1_launched;
                if (fetchedBusiness.current_dev_stage_index !== undefined) currentSoftwareDevelopmentStageIndex = fetchedBusiness.current_dev_stage_index;
                if (fetchedBusiness.current_cat2_stage_index !== undefined) currentCategory2StageIndex = fetchedBusiness.current_cat2_stage_index; 
                
                if (fetchedBusiness.company_health !== undefined) {
                     companyHealthPercentage = fetchedBusiness.company_health;
                }
                console.log("Global game variables updated from fetched data. Business Location:", businessLocation);
                return true; 
            } else {
                console.log('No businesses found in the response or data format is incorrect. Using defaults.');
                balance = 15000;
                companyHealthPercentage = 50;
                businessLocation = "Home-Based"; // Default location if no data
                return false; 
            }
        } catch (error) {
            console.error('Error fetching or processing user data:', error);
            businessLog(`Critical error fetching data: ${error.message}`, "penalty");
            balance = 15000;
            companyHealthPercentage = 50;
            businessLocation = "Home-Based"; // Default location on error
            return false; 
        }
    }

</script>
</body>
</html>
